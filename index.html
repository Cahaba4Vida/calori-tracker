<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calorie & Weight Tracker</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <link rel="stylesheet" href="styles.css?v=13" />
</head>
<body>
  <header class="row">
    <h1>Calorie & Weight Tracker</h1>
    <div class="auth">
      <button id="loginBtn">Login / Signup</button>
      <button id="logoutBtn">Logout</button>
    </div>
  </header>

  <div id="status" class="muted"></div>


  <div class="tabs hidden" id="tabs">
    <button class="tabbtn" id="tabDashboardBtn">Dashboard</button>
    <button class="tabbtn" id="tabSettingsBtn">Settings</button>
  </div>


  
  <main id="app" class="hidden">
    <div id="panelDashboard">
    <section class="card" id="todayCard">
      <h2>Today</h2>
      <div class="statStrip">
        <div class="statTile">
          <div class="statLabel">Remaining</div>
          <div class="statValue" id="todayRemaining">—</div>
        </div>
        <div class="statTile">
          <div class="statLabel">Entries</div>
          <div class="statValue" id="todayEntriesCount">0</div>
        </div>
      </div>
      <div class="todayGrid">
        <div><strong>Calories:</strong> <span id="todayCalories">—</span> / <span id="todayGoal">—</span></div>
        <div><strong>Protein:</strong> <span id="todayProtein">—</span> / <span id="todayProteinGoal">—</span></div>
        <div><strong>Carbs:</strong> <span id="todayCarbs">—</span> / <span id="todayCarbsGoal">—</span></div>
        <div><strong>Fat:</strong> <span id="todayFat">—</span> / <span id="todayFatGoal">—</span></div>
      </div>
      <div class="progress" title="Calories progress">
        <div id="progressBar"></div>
      </div>
      <div class="macroProgressList">
        <div class="macroProgressRow">
          <div>Protein</div>
          <div class="muted" id="proteinProgressText">—</div>
          <div class="microProgress"><div id="proteinProgressBar"></div></div>
        </div>
        <div class="macroProgressRow">
          <div>Carbs</div>
          <div class="muted" id="carbsProgressText">—</div>
          <div class="microProgress"><div id="carbsProgressBar"></div></div>
        </div>
        <div class="macroProgressRow">
          <div>Fat</div>
          <div class="muted" id="fatProgressText">—</div>
          <div class="microProgress"><div id="fatProgressBar"></div></div>
        </div>
      </div>
      <h3>Entries</h3>
      <ul id="entriesList"></ul>
    </section>

<section class="card" id="dailyGoalsCard">
      <div class="cardHeaderRow">
        <h2>Daily Goals</h2>
        <button type="button" class="sectionToggleBtn" id="toggleDailyGoalsBtn" aria-expanded="true" aria-controls="dailyGoalsBody">Collapse</button>
      </div>
      <div id="dailyGoalsBody" class="collapsibleBody">
      <div class="grid2">
        <div>
          <label>Calories</label>
          <input type="number" id="goalInput" placeholder="e.g. 2200" min="0" />
        </div>
        <div>
          <label>Protein goal (g, optional)</label>
          <input type="number" id="proteinGoalInput" placeholder="optional" min="0" />
        </div>
        <div>
          <label>Carbs goal (g, optional)</label>
          <input type="number" id="carbsGoalInput" placeholder="optional" min="0" />
        </div>
        <div>
          <label>Fat goal (g, optional)</label>
          <input type="number" id="fatGoalInput" placeholder="optional" min="0" />
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="saveGoalBtn">Save Goals</button>
      </div>
      <div id="goalDisplay" class="muted"></div>
      </div>
    </section>

    <section class="card" id="addFoodCard">
      <div class="cardHeaderRow">
        <h2>Add Food (Photo of nutrition label)</h2>
        <button type="button" class="sectionToggleBtn" id="toggleAddFoodBtn" aria-expanded="true" aria-controls="addFoodBody">Collapse</button>
      </div>
      <div id="addFoodBody" class="collapsibleBody">
      <div class="row">
        <div class="pill">Nutrition Label (accurate)</div>
      </div>
      <input id="photoInput" type="file" accept="image/*" capture="environment" />
      <div class="muted">Tip: get close, fill the frame with the Nutrition Facts panel.</div>

      <div style="height:10px"></div>
      <div class="row">
        <div class="pill">Plate Photo (estimate)</div>
      </div>
      <input id="plateInput" type="file" accept="image/*" capture="environment" />
      <div class="muted">Tip: capture the full plate in good light. Estimates are approximate.</div>

      <div style="height:14px"></div>
      <div class="row">
        <div class="pill">Manual Entry</div>
      </div>
      <div class="muted">Quick add calories/macros directly (no photo).</div>

      <div class="grid2">
        <div>
          <label>Calories (total)</label>
          <input id="manualCaloriesInput" type="number" min="0" step="1" placeholder="e.g. 450" />
        </div>
        <div>
          <label>Protein (g)</label>
          <input id="manualProteinInput" type="number" min="0" step="1" placeholder="optional" />
        </div>
        <div>
          <label>Carbs (g)</label>
          <input id="manualCarbsInput" type="number" min="0" step="1" placeholder="optional" />
        </div>
        <div>
          <label>Fat (g)</label>
          <input id="manualFatInput" type="number" min="0" step="1" placeholder="optional" />
        </div>
      </div>
      <label>Notes (optional)</label>
      <input id="manualNotesInput" type="text" placeholder="e.g. homemade chicken bowl" />
      <div class="quickAdds">
        <div class="muted">Quick fills</div>
        <div class="row">
          <button type="button" class="quickFillBtn" data-preset="light">Light snack</button>
          <button type="button" class="quickFillBtn" data-preset="meal">Balanced meal</button>
          <button type="button" class="quickFillBtn" data-preset="post">Post-workout</button>
        </div>
      </div>

      <div class="row end" style="margin-top:10px">
        <button id="manualSaveBtn">Save Manual Entry</button>
      </div>
      </div>
</section>



    <section class="card">
      <h2>Weight</h2>
      <div class="row">
        <input type="number" step="0.1" id="weightInput" placeholder="weight" />
        <button id="saveWeightBtn">Save Weight</button>
      </div>
      <div id="weightDisplay" class="muted"></div>
      <h3>Last 14 days</h3>
      <ul id="weightsList"></ul>
    </section>


    <section class="card">
      <h2>Weekly Trends (last 7 days)</h2>
      <div class="row">
        <div class="muted">Calories</div>
      </div>
      <canvas id="calChart" width="760" height="220"></canvas>
      <div class="row" style="margin-top:10px">
        <div class="muted">Weight</div>
      </div>
      <canvas id="wtChart" width="760" height="220"></canvas>
      <div class="muted">Tip: Weight chart uses gaps for missing days.</div>
    </section>

    <section class="card">
      <h2>Finish Day</h2>
      <button id="finishDayBtn">Get Score + Tips</button>
      <pre id="scoreOutput" class="pre"></pre>
    </section>

    <section class="card floatingChat" id="coachChatCard">
      <div class="chatHeaderRow">
        <h2>Coach Chat</h2>
        <button type="button" class="sectionToggleBtn" id="chatToggleBtn" aria-expanded="true" aria-controls="coachChatBody">Hide</button>
      </div>
      <div id="coachChatBody">
      <div class="row">
        <input id="chatInput" placeholder="Ask about today's log…" />
        <button id="sendChatBtn">Send</button>
      </div>
      <div id="aiThinking" class="thinking hidden" aria-live="polite">
        <span class="thinkingDots" aria-hidden="true">
          <span></span><span></span><span></span>
        </span>
        <span>AI is thinking…</span>
      </div>
      <pre id="chatOutput" class="pre"></pre>
      </div>
    </section>
  
    </div>

    <div id="panelSettings" class="hidden">

    <section class="card">
      <h2>Settings</h2>
      <div class="row">
        <label class="switch">
          <input type="checkbox" id="unitToggle" />
          <span class="slider"></span>
        </label>
        <div>
          <div><strong>Weight units:</strong> <span id="unitLabel">lbs</span></div>
          <div class="muted">Toggle to display weight in kilograms. Values are stored in lbs in the database.</div>
        </div>
      </div>
      <div class="row" style="margin-top:12px;">
        <label class="switch">
          <input type="checkbox" id="darkModeToggle" />
          <span class="slider"></span>
        </label>
        <div>
          <div><strong>Dark mode:</strong> <span id="darkModeLabel">Off</span></div>
          <div class="muted">Inverts app colors for a dark-style look.</div>
        </div>
      </div>
      <div class="row" style="margin-top:12px;">
        <button id="settingsAiGoalBtn">Generate AI calorie & macro goals</button>
      </div>
      <div id="aiPlanSummaryCard" class="computed" style="margin-top:12px;">
        <div><strong>Current AI plan:</strong> <span id="aiPlanSummaryCalories">Not set</span></div>
        <div id="aiPlanSummaryMacros" class="muted">Macros: —</div>
        <div id="aiPlanSummaryMeta" class="muted">Goal date: — • Activity: —</div>
      </div>
    </section>

    </div>
  </main>


  <div id="onboardingOverlay" class="onboardingOverlay hidden">
    <div class="onboardingModal">
      <div class="onboardingStep">Step <span id="onboardingStepNum">1</span> of 3</div>
      <h2 id="onboardingTitle">Welcome to Fitflow Calorie Tracker</h2>

      <div id="onboardingWelcomeScreen">
        <p>Welcome to Fitflow Calorie Tracker</p>
        <p class="muted">We’ll use a few quick inputs to set a calorie and macro target tailored to your timeline.</p>
        <button id="onboardingContinueBtn">Press to continue</button>
      </div>

      <div id="onboardingInputScreen" class="hidden">
        <div class="grid2">
          <div>
            <label>Current weight (<span class="aiInputUnitText">lbs</span>)</label>
            <input id="aiCurrentWeightInput" type="number" min="0" step="0.1" />
            <div id="aiCurrentWeightError" class="fieldError"></div>
          </div>
          <div>
            <label>Weight goal (<span class="aiInputUnitText">lbs</span>)</label>
            <input id="aiGoalWeightInput" type="number" min="0" step="0.1" />
            <div id="aiGoalWeightError" class="fieldError"></div>
          </div>
          <div>
            <label>Activity level</label>
            <select id="aiActivityLevelInput">
              <option value="sedentary">sedentary</option>
              <option value="light">light</option>
              <option value="moderate" selected>moderate</option>
              <option value="very_active">very active</option>
            </select>
          </div>
          <div>
            <label>Hit goal by</label>
            <input id="aiGoalDateInput" type="date" />
            <div id="aiGoalDateError" class="fieldError"></div>
          </div>
        </div>
        <p class="muted">Your weight is stored in lbs internally and converted automatically if you use kg display.</p>
        <button id="aiGetPlanBtn" style="margin-top:12px;">Get AI Plan</button>
        <div id="aiGoalLoading" class="muted hidden">Generating your plan…</div>
        <div id="aiGoalFlowError" class="muted" style="color:#b00020;"></div>
      </div>

      <div id="onboardingSuggestScreen" class="hidden">
        <p><strong>Daily calories:</strong> <span id="aiSuggestedCalories">—</span></p>
        <p><strong>Protein:</strong> <span id="aiSuggestedProtein">—</span>g &nbsp; <strong>Carbs:</strong> <span id="aiSuggestedCarbs">—</span>g &nbsp; <strong>Fat:</strong> <span id="aiSuggestedFat">—</span>g</p>
        <ul id="aiRationaleList"></ul>
        <div class="row">
          <button id="aiAcceptPlanBtn">Accept plan</button>
          <button id="aiDeclinePlanBtn">Decline</button>
        </div>
        <div id="aiDeclineHint" class="muted"></div>
        <div id="aiSuggestionError" class="muted" style="color:#b00020;"></div>
      </div>
    </div>
  </div>

  <script src="app.js?v=10"></script>

  <!-- Servings confirmation sheet -->
  <div id="sheetOverlay" class="overlay hidden"></div>
  <div id="servingsSheet" class="sheet hidden" role="dialog" aria-modal="true" aria-label="Confirm servings">
    <div class="sheetHeader">
      <div><strong>Confirm entry</strong></div>
      <button id="sheetCloseBtn" class="ghost">✕</button>
    </div>

    <div class="sheetBody">
      <label class="field">
        <div class="label">Servings eaten</div>
        <input type="number" id="servingsEatenInput" step="0.1" min="0" />
      </label>

      <label class="field">
        <div class="label">Calories per serving</div>
        <input type="number" id="calPerServingInput" step="0.1" min="0" />
      </label>

      <label class="field">
        <div class="label">Protein per serving (g)</div>
        <input type="number" id="proteinPerServingInput" step="0.1" min="0" />
      </label>

      <div class="computed">
        <div><strong>Total calories:</strong> <span id="totalCaloriesComputed">—</span></div>
        <div><strong>Total protein:</strong> <span id="totalProteinComputed">—</span></div>
      </div>

      <div class="row sheetActions">
        <button id="sheetCancelBtn">Cancel</button>
        <button id="sheetSaveBtn">Save Entry</button>
      </div>
      <div id="sheetError" class="muted" style="color:#b00020"></div>
    </div>
  </div>


  <!-- Plate estimate confirmation sheet -->
  <div id="estimateOverlay" class="estimate-overlay"></div>
  <div id="plateEstimateSheet" class="sheet hidden" role="dialog" aria-modal="true" aria-label="Confirm estimate">
    <div class="sheetHeader">
      <div><strong>Confirm estimate</strong> <span id="estimateBadge" class="badge">medium</span></div>
      <button id="estimateCloseBtn" class="ghost">✕</button>
    </div>

    <div class="sheetBody">
      <label class="field">
        <div class="label">Servings eaten</div>
        <input type="number" id="estimateServingsInput" step="0.1" min="0" />
      </label>

      <label class="field">
        <div class="label">Calories (total)</div>
        <input type="number" id="estimateCaloriesInput" step="1" min="0" />
      </label>

      <label class="field">
        <div class="label">Protein (g)</div>
        <input type="number" id="estimateProteinInput" step="1" min="0" />
      </label>

      <label class="field">
        <div class="label">Carbs (g)</div>
        <input type="number" id="estimateCarbsInput" step="1" min="0" />
      </label>

      <label class="field">
        <div class="label">Fat (g)</div>
        <input type="number" id="estimateFatInput" step="1" min="0" />
      </label>

      <div class="computed">
        <div class="label">Assumptions</div>
        <ul id="estimateAssumptions"></ul>
        <div id="estimateNotes" class="muted"></div>
      </div>

      <div class="row sheetActions">
        <button id="estimateCancelBtn">Cancel</button>
        <button id="estimateSaveBtn">Save Entry</button>
      </div>
      <div id="estimateError" class="muted" style="color:#b00020"></div>
    </div>
  </div>

</body>
</html>
